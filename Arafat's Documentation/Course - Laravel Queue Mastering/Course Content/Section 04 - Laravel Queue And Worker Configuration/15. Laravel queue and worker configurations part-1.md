# **15. Laravel Queue & Worker Configurations — Part 1**

This lesson focuses on understanding the **options, flags, and configurations** used to control **Laravel queue workers**, and how these map into **Supervisor** configurations in production.

---

# **1. Worker Configuration via `php artisan queue:work`**

The instructor starts by running:

```bash
php artisan help queue:work
```

This command lists all CLI options available when starting a worker manually.

These options are **central** because Supervisor will eventually run:

```
php artisan queue:work <connection> <options>
```

Everything we configure here becomes part of Supervisor config later.

---

# **2. The “Connection” Option**

```
--connection=
```

This corresponds to:

```
config/queue.php
```

Connections include:

* `sync`
* `database`
* `beanstalkd`
* `redis`
* `null`

Example:

```
php artisan queue:work redis
```

This will make the worker **listen only to jobs dispatched to the Redis connection**.

---

# **3. Queue Name**

The option:

```
--queue=
```

Selects the **queue bucket**.

Example:

```bash
php artisan queue:work redis --queue=emails
```

Even on the same connection, you can have many queues:

```
emails
pdf
image-processing
notifications
```

Supervisor will run separate workers per queue.

**Difference between connection vs queue:**

* **Connection** = which backend (Redis, DB)
* **Queue** = which “bucket” inside the backend

---

# **4. Worker Name**

```
--name=
```

This is used for:

* Debugging (Horizon)
* Logging
* Monitoring

It does not affect logic—just readability.

---

# **5. `--once`**

Runs **only one job**, then exits.

Used in:

* Cron-based workers
* Environments where memory leaks are possible

---

# **6. `--stop-when-empty`**

Worker exits **when no more jobs are in the queue**.

Useful when:

* You want scheduled workers (not daemon workers)
* You want to flush memory after finishing a pile of jobs

---

# **7. `--backoff`**

Controls retry delay for **failed jobs**.

Default: `0` seconds.

If a job fails at 10:00:00 and you set:

```bash
--backoff=10
```

Then the retry will be at: **10:00:10**

---

# **8. `--max-jobs`**

Worker exits after processing a certain number of jobs.

```bash
--max-jobs=250
```

Useful to prevent:

* Memory leaks
* Long-running PHP processes growing large

(Added clarification: PHP garbage collection is imperfect; long workers may slowly grow in memory.)

---

# **9. `--max-time`**

Worker exits after X seconds.

Example:

```
--max-time=3600
```

Worker stops after 1 hour.

---

# **10. `--force`**

Allows workers to run **even when app is in maintenance mode**.

Use with caution.

---

# **11. `--memory`**

Sets memory limit **for the worker process**.

Example:

```
--memory=512
```

Worker will exit if it exceeds 512MB.

---

# **12. `--sleep`**

Time (in seconds) to wait **when there are no jobs**.

Default: **3 seconds**

Worker behavior:

```
Loop:
  - Check queue
  - If empty → sleep 3 seconds
  - Repeat
```

---

# **13. `--rest`**

Seconds to rest **between jobs**.

Useful if:

* Your workers overwhelm the database
* You want to slow down processing for rate-limited APIs

---

# **14. `--timeout`**

**VERY IMPORTANT**

Default: `60 seconds`

If a job takes longer than this, worker kills it → job marked as failed.

If you have long-running tasks (PDF, video conversion, reports):

```
--timeout=600   # 10 minutes
```

---

# **15. `--tries`**

How many times a job should be retried if it fails.

Default = `1` (no retry)

Example:

```
--tries=3
```

Common values: **1–3**

---

# **16. Supervisor Configuration**

Later, we convert worker CLI options into Supervisor config.

Supervisor block example:

```ini
[program:pdf-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work redis --queue=pdf --timeout=120 --sleep=3 --tries=3
autostart=true
autorestart=true
user=www-data
numprocs=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/pdf.log
stopwaitsecs=3600
```

Explanation:

| Key                         | Meaning                                          |
| --------------------------- | ------------------------------------------------ |
| `numprocs=3`                | Start 3 workers for this queue                   |
| `stopwaitsecs`              | How long Supervisor waits before killing process |
| `stdout_logfile`            | Where worker logs go                             |
| `autostart` / `autorestart` | Always keep workers alive                        |
| `command`                   | The queue worker command                         |

---

# **17. Supervisor Behavior inside Sail (Docker)**

Important difference:

* Sail **does not run Supervisor as a daemon**.
* So commands like `supervisorctl reread` and `supervisorctl update` **do NOT work**.

Because Sail containers are small:

* Must **restart the Docker container** whenever Supervisor configs change.

---

# **18. Setting Up Custom Workers in Laravel Sail**

Instead of embedding into Docker image, config files were placed in:

```
/docker/8.3/supervisor.d/
```

Benefit:

* Mounted volume → no need to rebuild Docker image
* Supervisor reads configs on container start

---

# **19. Debugging: “queue connection not configured”**

Common mistake:

Using:

```
queue:work pdf
```

Laravel thinks **pdf** is a connection, not a queue.

Correct usage:

### For queue bucket:

```
--queue=pdf
```

### For connection:

```
php artisan queue:work redis --queue=pdf
```

The instructor fixed it by modifying:

```php
WordProcessorJob::dispatch()->onQueue('pdf');
```

---

# **20. Verifying Workers Running**

After restarting Sail the output showed multiple workers:

```
pdf-worker_00 RUNNING
default-worker_00 RUNNING
```

---

# **21. Logging From Workers**

Supervisor config requires:

```
stdout_logfile=/var/log/supervisor/pdf.log
redirect_stderr=true
```

Instructor creates:

```
/var/log/supervisor/pdf.log
```

Inside Sail container:

```bash
docker exec -it <container> bash
touch /var/log/supervisor/pdf.log
```

Workers should now log output there.

---

# **22. Problem: Logs Not Appearing**

Instructor notes:

* Output still didn’t appear
* Suspects default logging + missing redirection
* Plans to debug and fix path or permission issue