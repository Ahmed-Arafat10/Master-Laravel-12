# **14. Addition of Word-to-PDF Converter & Background Job**

This lesson begins the transition from **synchronous** queue execution to **asynchronous** queue workers, preparing for real-world high-latency operations such as Word → PDF conversion, email sending, and heavy I/O operations.

---

# **1. Branch Setup and New Files**

The instructor begins by:

### ✔ Switching to a new Git branch:

```
pdf-converter
```

### ✔ Adding a new top-level directory:

```
/documents
```

### ✔ Installing required composer packages:

These packages are used to read and convert Word documents:

```
composer require phpoffice/phpword
composer require dompdf/dompdf
```

### Why these packages?

* **PHPWord**: Loads, edits, and processes `.doc` and `.docx` files.
* **DomPDF**: Used as a *writer* for PHPWord so it can export to PDF.

(Added clarification: PHPWord **does not** internally render PDFs; it delegates to external “writers”—DomPDF, TCPDF, MPDF, etc.)

---

# **2. Important Production Notes (Benchmark + Library Choice)**

### ⚠ When using Word→PDF conversion in production:

The instructor warns:

* Different PDF engines (DomPDF, mPDF, TCPDF) perform **very differently**.
* Must benchmark yourself to see:

    * Speed
    * Memory usage
    * Rendering accuracy
    * How they handle large documents

### Laravel includes a built-in benchmarking helper:

```php
Route::get('/benchmark', function () {
    return Benchmark::measure([
        'convert' => function () {
            WordProcessorJob::dispatchSync($email, $fileName);
        },
    ]);
});
```

Benchmark results:

* Return in milliseconds
* Are provided as an array of operation results

(Added clarification: You cannot benchmark asynchronous jobs because dispatching is instant; benchmark them synchronously for accurate timing.)

---

# **3. UI for Uploading Word Files**

A new Livewire component was added:

### ✔ Component:

`UploadWordComponent.php`

### ✔ View:

`upload-word-component.blade.php`

This provides:

* Input field to upload a Word document
* Input for email
* Button to dispatch the background job

---

# **4. WordProcessorJob — Background Conversion Job**

A new job was added:

```
WordProcessorJob
```

Core responsibilities:

1. Load the uploaded `.docx` file using PHPWord.
2. Assign the PDF writer:

```php
Settings::setPdfRendererPath(base_path('vendor/dompdf/dompdf'));
Settings::setPdfRendererName('DomPDF');
```

3. Read the document:

```php
$phpWord = \PhpOffice\PhpWord\IOFactory::load($inputPath);
```

4. Convert it to PDF:

```php
$writer = \PhpOffice\PhpWord\IOFactory::createWriter($phpWord, 'PDF');
$writer->save($outputPath);
```

5. Email the resulting PDF to the user using a new mailable:
   `SendUserPDF`

### About the new mailable:

* Has minimal HTML view
* Uses `$message->attach($outputPath)` to attach the converted PDF

---

# **5. Why Asynchronous Queues Matter Here**

The instructor emphasizes:

### Without queues:

* The request blocks until:

    * Word document loads
    * Word → PDF conversion finishes
    * Email with attachment is sent

This may take **seconds** or **minutes** depending on file size.

### With queues:

* User gets instant response (upload successful)
* Heavy work happens in the background

---

# **6. Demonstration of “Synchronous vs Asynchronous”**

Initially, the job runs **synchronously**, so the instructor simulates real delays by adding:

```php
sleep(5);
```

### Without queue worker:

1. User clicks “Send”
2. Browser waits 5 seconds
3. Email arrives after those 5 seconds

This simulates real-world delays:

* Server load
* Network speed
* PDF rendering time
* External email APIs (AWS SES, Mailgun, etc.)

---

# **7. Preparing for Queue Workers**

Laravel Sail (Docker version of Laravel) comes with **Supervisor** installed.

Supervisor is a Linux process manager that keeps queue workers running.

### Supervisor Config Template

Laravel provides a sample supervisor config:

```
/vendor/laravel/framework/src/Illuminate/Queue/resources/supervisor.conf
```

The instructor used this as a base and customized it to create his own worker configuration.

### Docker Behavior

* Sail uses *bind mounts* → the supervisor config can be placed directly in project files.
* No need to manually `docker cp` into the container unless you want to.

(Added clarification: In production you typically place supervisor config in `/etc/supervisor/conf.d/`.)

---

# **8. Route for PDF Conversion (for testing)**

A simple route was added:

```php
Route::get('/convert-pdf', function () {
    return view('documents.convert');
});
```

This is used to load the Livewire PDF uploader and test background jobs.

---

# **9. Email Sending Demo**

On submitting:

* Word file is uploaded
* Queued job is dispatched (currently synchronous)
* Email with PDF attachment immediately appears in Mailpit

---

# **10. Local Performance vs Production Reality**

The instructor explains:

### Local (fast):

* Same machine
* No network delay
* Extremely fast CPU
* Attachments are local
* Mailpit is local

### Production (slow):

* PDF conversion is CPU heavy
* I/O blocked by server load
* Users send much larger Word documents
* Email sending APIs add latency
* Dozens or hundreds of users at once

→ These delays make background queues **essential**.