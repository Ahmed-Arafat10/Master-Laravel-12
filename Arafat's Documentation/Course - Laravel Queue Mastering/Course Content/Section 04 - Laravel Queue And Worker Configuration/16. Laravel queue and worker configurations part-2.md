# **16. Laravel Queue & Worker Configurations — Part 2**

This lesson continues from Part 1 and focuses mainly on:

* Fixing worker logging
* Understanding where worker configuration files should live in production
* Understanding Supervisor’s file inclusion mechanism
* Working inside Docker/Sail containers
* Installing Supervisor & utilities inside containers

---

# **1. Fixing the Worker Log File Issue**

The instructor discovered why worker logs were not appearing.

### ❌ Incorrect key used:

```ini
stdout_logfile=/var/log/supervisor/pdf.log
```

This logs only STDOUT, but Supervisor expects:

### ✔ Correct key:

```ini
logfile=/var/log/supervisor/pdf.log
```

Once fixed, logs started to work:

* Job executed immediately
* Email took longer because PDF generation is slow
* Log file clearly showed the processing time

This demonstrates why logging workers is critical—especially for debugging queue delays.

---

# **2. Real Impact of Slow Jobs**

Even a **1–2 second** job can freeze your entire application if run synchronously.
By logging worker execution you see:

* slow conversions
* long email sending
* delays due to external services

Workers solve this by moving the heavy tasks **off** the main request → background.

**(Added clarification: You should always avoid CPU-heavy or IO-heavy tasks inside the HTTP request cycle.)**

---

# **3. Development vs Production Worker Config Paths**

In the instructor’s development environment (Sail):

```
/docker/8.3/supervisor.d/*.conf
```

But **in real production Linux servers**, Supervisor configuration MUST go here:

```
/etc/supervisor/conf.d/*.conf
```

### Why?

* `/etc/supervisor/supervisord.conf` includes everything inside `conf.d`
* This is the official Linux-standard directory for Supervisor programs
* Putting multiple `.conf` files here allows you to manage many workers cleanly

Example:

```
/etc/supervisor/conf.d/pdf-worker.conf
/etc/supervisor/conf.d/email-worker.conf
/etc/supervisor/conf.d/default-worker.conf
```

---

# **4. production Example Worker File**

This is the same configuration used in the lesson, formatted for production:

```ini
[program:pdf-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work redis --queue=pdf --sleep=3 --timeout=300 --tries=3
autostart=true
autorestart=true
numprocs=3
user=www-data
redirect_stderr=true
stdout_logfile=/var/log/supervisor/pdf-worker.log
stopwaitsecs=300
```

Supervisor automatically picks this up because `supervisord.conf` includes:

```ini
[include]
files = /etc/supervisor/conf.d/*.conf
```

---

# **5. Installing Supervisor (Production Server)**

On Ubuntu:

```bash
sudo apt update
sudo apt install supervisor
```

Supervisor then runs automatically as a system service.

To add workers:

1. Create a `.conf` file in `/etc/supervisor/conf.d/`
2. Run:

   ```bash
   sudo supervisorctl reread
   sudo supervisorctl update
   sudo supervisorctl reload
   ```

---

# **6. Running Supervisor Inside Laravel Sail (Docker)**

Inside Sail, Supervisor works differently:

### ❌ NOT running as a daemon

So commands like:

```
supervisorctl reread
supervisorctl update
```

**do NOT work** inside Sail.

### Why?

Because Sail uses a simplified Supervisor that’s not fully initialized as a system daemon.

### How to reload workers in Sail:

➡ **Restart the entire Docker container**

```bash
./vendor/bin/sail down
./vendor/bin/sail up -d
```

This forces Supervisor inside the container to re-read configs.

---

# **7. Editing Files Inside Sail Container**

The instructor demonstrates installing tools inside the Sail container:

## Update package list:

```bash
apt-get update
```

## Install Supervisor:

```bash
apt-get install supervisor
```

## Install vim:

```bash
apt-get install vim
```

Note:
The instructor tried `apt-get upgrade` which didn't work at first because the package list was not updated. After `apt-get update`, installation succeeded.

---

# **8. Using `vim` or tools inside Sail**

After installing `vim`:

```bash
vim /etc/supervisor/conf.d/pdf-worker.conf
```

This allows:

* Editing worker configs
* Debugging config issues
* Testing before building production Docker images

---

# **9. Building Docker Images for Production (Mentioned Conceptually)**

Instructor notes:

> "I can test everything inside the Sail container, then build a new Dockerfile and push it to a registry."

The development workflow:

1. Test workers inside Sail
2. Move configuration to Production Dockerfile
3. Build and push image
4. Run on Kubernetes/ECS/Docker Swarm/etc.