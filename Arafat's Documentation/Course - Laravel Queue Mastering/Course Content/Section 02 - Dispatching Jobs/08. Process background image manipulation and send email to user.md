Below is the **complete documentation for Lesson 8: Background Image Manipulation and Sending Email to User**.
Everything from the transcript is included, cleaned, clarified, and reorganized into proper documentation sections.
Any additional explanations I add are marked with **(Added clarification: …)**.

---

# **8. Processing Background Image Manipulation and Sending Email to User**

## **Overview**

In this lesson, the instructor continues building the background image-processing pipeline. The goal is to:

1. Take an uploaded photo
2. Process it into multiple sizes
3. Save the processed images
4. Attach them to an email
5. Send the email to the user

This lesson focuses on the *first functional implementation* of resizing, saving, and attaching files using a background job — preparing the code for later refactoring into multiple jobs.

---



# **3. Handling File Extensions Correctly**

The instructor needed to extract the filename **without the original extension**, because the new files are saved as `.jpeg`:

Example correction:

```php
$info = pathinfo($this->photoName);

$nameOnly = $info['filename']; // ex: "image" from "image.png"
```
> or use `pathinfo($this->fileName, PATHINFO_FILENAME)`

Then use:

```php
$output100  = $attachmentPath . $nameOnly . '_100.jpeg';
$output300  = $attachmentPath . $nameOnly . '_300.jpeg';
```

This ensures:

* Clean filenames
* Valid file paths
* No null bytes (which break the Mail attachment API)

---

# **4. Working With the Image Library**

The instructor experiments with several resizing APIs:

### Initially used `resize()` but got wrong aspect ratio

Then switched to:

* `scale()` which maintains proportions better
* Works correctly with JPEG output
* Produces acceptable quality for now

```php
 /**
     * @param string $imgName
     * @param int $scaleHeight
     * @param string $imgExtension
     * @param string $srcImgDir
     * @param string $dstImgDir
     * @param string $storagePrefixPath
     * @return string
     */
    private function changePicScale(string $imgName, int $scaleHeight = 100, string $imgExtension = 'jpeg', string $srcImgDir = 'pics', string $dstImgDir = 'picsGenerated', string $storagePrefixPath = 'app/private/'): string
    {
        $image = $this->imageManager->read(
            $this->getFileStoragePath($imgName, $storagePrefixPath . $srcImgDir)
        );
        //dd($image);
        $image->scale(height: $scaleHeight);
        $imageEncoded = $image->{'to' . Str::title($imgExtension)}();
        $imgNewName = $this->generateNewImageName($imgName, $scaleHeight);
        $imageEncoded->save(
            $this->getFileStoragePath($imgNewName, $storagePrefixPath . $dstImgDir)
        );
        return $imgNewName;
    }
```

---

# **5. Creating Output Files**

The instructor created an `output` directory:

```
storage/app/photos/output
```

Then saved multiple resized versions:

* `_100.jpeg` (100 width)
* `_300.jpeg` (300 width)

This gives the final email two attachments.

Later lessons will extract this logic into separate jobs.

---


Final correct usage:

```php
$mail->attach($output100);
$mail->attach($output300);
```

Everything must be:

* A valid path
* To an existing file
* Without null bytes
* With correct extension

Once paths were corrected, the attachments worked.

---

# **7. Successful Test with Mailpit**

After fixing paths + saving + attaching:

1. The email was sent
2. Mailpit showed **two JPEG attachments**
3. Images were scaled correctly
4. Aspect ratio was maintained using `scale()`

Even though JPEG quality was not ideal, the pipeline worked end-to-end.

---

# **8. Preparing for the Next Step: Job Extraction**

The instructor closes by explaining the next major change:

> The image processing will be moved OUT of the constructor and OUT of the single job.

This is because:

* Only simple scalar values should be serialized in constructors (filename, email).
* Image objects and manipulation results should *always* be inside the `handle()` method.
* Large processing logic should be split into **multiple jobs**.

The planned architecture:

### Background Jobs:

* `CreateSmallImage`
* `CreateMediumImage`
* `CreateLargeImage`

### Then:

A final job:

* `SendUserPhotos`
  …which waits for all resizing jobs to complete, then collects all generated outputs and attaches them to the email.

### Background job orchestration will use:

* `Bus::batch()` (parallel)
  or
* `Bus::chain()` (sequential)