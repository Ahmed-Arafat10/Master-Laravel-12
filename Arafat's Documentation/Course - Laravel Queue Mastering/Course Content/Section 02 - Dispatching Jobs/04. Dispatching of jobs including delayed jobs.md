# **4. Dispatching Jobs (Including Delayed Jobs)**

## **Overview**

In this lesson you learn:

* How jobs are dispatched in Laravel
* How synchronous vs asynchronous queue connections affect dispatching
* How to use delays (`delay()`)
* How to use `dispatchAfterResponse()`
* Common mistakes and gotchas when dispatching
* Practical examples from routes and controllers
* What happens when the queue driver is `sync`
* Preparing for the upcoming image processing application

---

# **1. Dispatching Jobs in Laravel**

Jobs can be dispatched from:

* Controllers
* Routes (closures)
* Services
* Event listeners
* Anywhere the Laravel container can resolve the job

The most common syntax:

```php
DailyEmails::dispatch($user);
```

Under the hood this uses the `Dispatchable` trait on your job class.

---

# **2. Synchronous Driver Behavior (`sync` connection)**

In the `.env` file:

```
QUEUE_CONNECTION=sync
```

The `sync` connection forces jobs to run **immediately**, inside the same HTTP request.

So even if your job:

* implements `ShouldQueue`
* uses `Queueable`
* looks asynchronous

…it will **still run synchronously**.

### Example from the lesson:

```php
DailyEmails::dispatch();
```

The instructor added a `dd("Died inside job")` in the job’s `handle()` method.

When visiting the route:

* The job runs instantly.
* The page dies immediately.
* Nothing is put into the queue.

This demonstrates that:

> **Queue behavior depends entirely on the queue connection, not the job class.**

---

# **3. Dispatching a Job From a Route Closure**

Given this route:

```php
Route::get('/', function () {
    DailyEmails::dispatch();
    return "Job dispatched!";
});
```

With `QUEUE_CONNECTION=sync`:

* The job executes instantly
* The route response is delayed until the job finishes
* It blocks the main thread

This is **exactly why async queues exist** — to avoid blocking the user’s request.

---

# **4. Delayed Jobs**

Laravel allows you to delay job execution.

### Syntax:

```php
DailyEmails::dispatch()->delay(now()->addMinutes(10));
```

Or using Carbon directly:

```php
use Carbon\Carbon;

DailyEmails::dispatch()->delay(Carbon::now()->addMinutes(10));
```

### Use Cases for Delayed Jobs:

* Send promotional email 10 minutes after signup
* Push a reminder notification at a future time
* Delay tasks during heavy traffic
* Stagger heavy processing jobs to reduce load
* Throttle system load by distributing jobs over time

> **Note:** With `sync` driver, delays have no effect.
> The job still runs immediately.

---

# **5. dispatchAfterResponse()**

Laravel also supports:

```php
DailyEmails::dispatchAfterResponse();
```

This method:

* Runs **after the HTTP response is sent to the browser**
* Does **not** wait for queue workers
* Does **not** support delays
* Runs only on supported servers (FastCGI, Swoole, Octane, etc.)

### Important Notes:

* It does **not** work with `php artisan serve`
* Laravel Sail supports it because it uses proper FastCGI stack
* It still runs synchronously from PHP perspective — but after response

This is a special mechanism — not a real queue job — that helps speed up responses.

(Added clarification: `dispatchAfterResponse()` is great for simple tasks like logging user actions.)

---

# **6. Dispatching Syntax Variations**

### 6.1 The recommended syntax

```php
DailyEmails::dispatch();
```

### 6.2 Controller-style dispatch (only works inside controllers)

```php
$this->dispatch(new DailyEmails());
```

Using `$this->dispatch()` inside a route closure **does NOT work**, because closures don’t have controller context.

In routes you must use:

```php
DailyEmails::dispatch();
```

---

# **7. What Happens Next**

After covering basic dispatching, the instructor introduces the next part of the course:

**Building an image processing mini-application**, where:

* A user uploads an image
* Background jobs generate multiple sizes
* You will compare performance using:

    * Sync driver
    * Redis driver
    * Database driver

This prepares you for more advanced features like:

* Dependent jobs
* Job chaining
* Complex processing pipelines

---

# **8. Summary of Important Concepts**

### ✔ How to dispatch a job

```php
DailyEmails::dispatch();
```

### ✔ How sync driver behaves

* Runs jobs immediately
* Blocks the request
* Ignores delays

### ✔ How to delay a job

```php
->delay(now()->addMinutes(10))
```

### ✔ dispatchAfterResponse()

* Runs after HTTP response
* Only works on proper servers (e.g., inside Sail)
* Ignores delays
* Not a replacement for true queue workers

### ✔ Dispatching from routes

Use:

```php
DailyEmails::dispatch();
```

Not:

```php
$this->dispatch();
```

### ✔ Preparing for job-based application

* Upload picture
* Resize in background
* Compare queue drivers
* Avoid blocking main thread