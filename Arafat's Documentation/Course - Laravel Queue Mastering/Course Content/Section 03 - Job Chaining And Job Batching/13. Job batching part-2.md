3# **13. Job Batching – Part 2**

This lesson continues exploring **Laravel Job Batching**, focusing on:

* Fixing common batching issues
* Handling batch failures
* Cancelling batches
* `Batchable` trait usage
* Batching lifecycle callbacks
* Middleware for cancellation
* Mixing batches + chains
* Naming batches
* Running batches on specific queues/connections
* Pruning batch history

This expands your mental model for advanced queue orchestration in Laravel.

---

# **1. Fixing Previous Errors When Using Batching**

The instructor revisits the previous issue:

### ❌ The batch wasn’t running correctly

This happened because:

### ❗ They used `$this` inside the batch `then()` callback.

Batch callbacks must be **serializable closures**, so you cannot use `$this` (which may contain non-serializable Livewire UploadedFile objects).

**Fix: Pass all needed data explicitly into the closure:**

```php
->then(function () use ($email, $fileOutputPath) {
    SendUserEmail::dispatch($email, $fileOutputPath, $sizes);
});
```

After removing `$this`, batching began working correctly.

The instructor confirmed:

* The batch ran
* All jobs executed
* Final email sent successfully

---

# **2. Finalizing the Fix and Committing Code**

The instructor committed work with a message:

> “Separated jobs to … and added migrations for queue tables, including batching and failed jobs”

This indicates the full batching infrastructure is now in place:

* `failed_jobs`
* `jobs` (queue table for database driver)
* `job_batches`

---

# **3. Important Behavior: Batch Failure Does NOT Stop Other Jobs**

Unlike job chaining:

| Feature                                  | Chaining | Batching   |
| ---------------------------------------- | -------- | ---------- |
| If job fails → everything stops          | ✔ Yes    | ✖ No       |
| Remaining jobs continue                  | ✖ No     | ✔ Yes      |
| You must manually check for cancellation | —        | ✔ Required |

This was demonstrated:

* Even when image resize jobs failed, the email job still ran.
* Because batches don’t auto-stop on failure.

---

# **4. Stopping Jobs Manually Inside Batch Jobs**

To stop job execution when the batch is cancelled:

### Option A — Manual check inside `handle()`

```php
if ($this->batch()->cancelled()) {
    return;
}
```

### Option B — Use Middleware

Better approach:

```php
public function middleware()
{
    return [ new SkipIfBatchCancelled ];
}
```

**This middleware automatically prevents job execution if the batch has been cancelled.**

(Added clarification: Laravel includes `SkipIfBatchCancelled` middleware.)

---

# **5. Understanding Batch Cancellation vs Failures**

The instructor clarifies:

* A *failed job* does **not** cancel the batch.
* The batch is only marked as **cancelled** when:

    * You explicitly call `$this->batch()->cancel()`
    * Or use batch middleware to cancel under certain conditions
    * Or an external system cancels it

So:

* Failed jobs = ok, batch continues
* Cancelled batch = batch marked as cancelled, but jobs still run unless prevented using middleware or manual check

(Added clarification: This is intentional, because batching is meant for *parallel*, *independent* work.)

---

# **6. Allowing Failures — `allowFailures()`**

By default, batching:

* Counts failures
* Marks batch as “finished with failures”
* Does NOT cancel the batch
* Still triggers the `then()` callback

If you want Laravel to *treat failed jobs as valid*, call:

```php
->allowFailures()
```

Meaning:

* A failed job is *not* considered a failure
* Batch is not marked cancelled
* Batch is considered “successful” for purposes of `then()`

**This is useful when errors are expected and non-critical.**

---

# **7. Batch Lifecycle Callbacks**

Laravel supports several callbacks:

| Callback   | When it Runs                                      |
| ---------- | ------------------------------------------------- |
| `then`     | After **all jobs finish successfully**            |
| `catch`    | When **any job in the batch fails**               |
| `finally`  | Runs **always**, regardless of success or failure |
| `progress` | Called during batch execution (when % changes)    |

Example:

```php
Bus::batch($jobs)
    ->progress(function (Batch $batch) {
        // track progress or update UI
    })
    ->then(function (Batch $batch) {
        // all jobs completed SUCCESSFULLY
    })
    ->catch(function (Batch $batch, Throwable $e) {
        // a job failed
    })
    ->finally(function (Batch $batch) {
        // always run
    })
    ->dispatch();
```

---

# **8. Naming a Batch**

Useful for debugging in Horizon or Telescope:

```php
->name('send-user-email')
```

---

# **9. Running Batches on Custom Connections and Queues**

Examples:

### Run on Redis:

```php
->onConnection('redis')
```

### Run on specific queue:

```php
->onQueue('send-emails')
```

You can combine:

```php
Bus::batch($jobs)
    ->onConnection('redis')
    ->onQueue('send-emails')
    ->dispatch();
```

---

# **10. Mixing Batches and Chains**

Laravel allows advanced configurations:

### ✔ Put batches inside chains

### ✔ Put chains inside batches

### Example: Chain inside batch

```php
Bus::batch([
    Bus::chain([
        new GenerateReport,
        new CompressReport,
        new UploadReport,
    ]),
    new NotifyUser,
])->dispatch();
```

### Example: Batch inside chain

```php
$batch = Bus::batch([...])->dispatch();

Bus::chain([
    new PrepareUser,
    $batch,
    new FinalizeUser
])->dispatch();
```

This works because:

* Batches return a `PendingBatch` instance, which can be chained
* Chains guarantee order
* Batches handle parallel execution inside the chain

(Added clarification: The batch itself does NOT run inside the chain until the chain reaches that step.)

---

# **11. Cancelling a Batch Programmatically**

From inside a job:

```php
$this->batch()->cancel();
```

This:

* Marks the batch as cancelled
* Next jobs can check cancellation with:

```php
if ($this->batch()->cancelled()) return;
```

Or rely on middleware to skip jobs automatically.

---

# **12. Viewing Batches in Database**

Batch records live in:

```
job_batches
```

This table stores:

* `id` (UUID)
* `name`
* `total_jobs`
* `pending_jobs`
* `failed_jobs`
* `cancelled_at`
* `finished_at`
* `options`
* `created_at`

### Important: Batch rows are **not automatically removed**

You must prune them manually or via scheduled tasks.

---

# **13. Pruning Batch Entries**

Laravel provides:

```
php artisan queue:prune-batches
```

Options include:

* How many hours to retain batch history
* Whether to remove unfinished/cancelled batches

Example:

```bash
php artisan queue:prune-batches --hours=168
```

or with Sail:

```bash
./vendor/bin/sail artisan queue:prune-batches --hours=168
```

Set `--hours=0` to delete all batches immediately.